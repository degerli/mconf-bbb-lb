<!DOCTYPE html><html lang="en"><head><title>routes/index</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="routes/index"><meta name="groc-project-path" content="routes/index.coffee"><meta name="groc-github-url" content="https://github.com/mconf/mconf-bbb-lb"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/mconf/mconf-bbb-lb/blob/master/routes/index.coffee">routes/index.coffee</a></div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="router-module">Router module</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">BigBlueButton = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../lib/bigbluebutton&quot;</span><span class="p">)</span>
<span class="nv">LoadBalancer = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../lib/load_balancer&quot;</span><span class="p">)</span>
<span class="nv">Logger = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../lib/logger&quot;</span><span class="p">)</span>
<span class="nv">Meeting = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/meeting&quot;</span><span class="p">)</span>
<span class="nv">Nagios = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../lib/nagios&quot;</span><span class="p">)</span>
<span class="nv">Server = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/server&quot;</span><span class="p">)</span>
<span class="nv">Utils = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../lib/utils&quot;</span><span class="p">)</span>
<span class="nv">config = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../config&quot;</span><span class="p">)</span>
<span class="nv">request = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
<span class="nv">url = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="helpers">Helpers</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Basic handler that tries to find the meeting using the meetingID provided
in the request and checks the checksum. If the meeting is not found or the
checksum is incorrect it responds with an error.
Otherwise it calls the callback <code>callback</code> with the meeting object as argument.</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.basicHandler = </span><span class="nf">(req, res, callback) -&gt;</span>
  <span class="nv">urlObj = </span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="nv">m_id = </span><span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s2">&quot;meetingID&quot;</span><span class="p">]</span>
  <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="s2">&quot; request with: &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span><span class="p">),</span> <span class="nx">m_id</span>

  <span class="nv">meeting = </span><span class="nx">Meeting</span><span class="p">.</span><span class="nx">getSync</span><span class="p">(</span><span class="nx">m_id</span><span class="p">)</span>
  <span class="nx">unless</span> <span class="nx">meeting</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;failed to find meeting&quot;</span><span class="p">,</span> <span class="nx">m_id</span>

    <span class="nv">server = </span><span class="nx">LoadBalancer</span><span class="p">.</span><span class="nx">defaultServer</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">server</span><span class="o">?</span>
      <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;redirecting to the default server &quot;</span> <span class="o">+</span> <span class="nx">server</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">m_id</span>
      <span class="nx">LoadBalancer</span><span class="p">.</span><span class="nx">handle</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">server</span>
    <span class="k">else</span>
      <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;there&#39;s no default server, sending an invalidMeeting response&quot;</span><span class="p">,</span> <span class="nx">m_id</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span> <span class="s2">&quot;xml&quot;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">config</span><span class="p">.</span><span class="nx">bbb</span><span class="p">.</span><span class="nx">responses</span><span class="p">.</span><span class="nx">invalidMeeting</span>
    <span class="k">return</span> <span class="kc">false</span>

  <span class="nx">callback</span> <span class="nx">meeting</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="routes-handlers">Routes handlers</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>General index.</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.index = </span><span class="nf">(req, res) -&gt;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span>
    <span class="nv">title: </span><span class="s2">&quot;Mconf - BigBlueButton Load Balancer&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>BigBlueButton api index.</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.apiIndex = </span><span class="nf">(req, res) -&gt;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span> <span class="s2">&quot;xml&quot;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">config</span><span class="p">.</span><span class="nx">bbb</span><span class="p">.</span><span class="nx">responses</span><span class="p">.</span><span class="nx">apiIndex</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Validates the checksum in the request <code>req</code>.
If it doesn't match the expected checksum, we'll send
an XML response with an error code just like BBB does and
return false. Returns true if the checksum matches.</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.validateChecksum = </span><span class="nf">(req, res) -&gt;</span>
  <span class="nv">urlObj = </span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="nv">checksum = </span><span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s2">&quot;checksum&quot;</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Matches the checksum in the url with the expected checksum</p></div></div><div class="code"><div class="wrapper">  <span class="nx">unless</span> <span class="nx">checksum</span> <span class="o">is</span> <span class="nx">BigBlueButton</span><span class="p">.</span><span class="nx">checksum</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">lb</span><span class="p">.</span><span class="nx">salt</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;checksum check failed, sending a checksumError response&quot;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span> <span class="s2">&quot;xml&quot;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">config</span><span class="p">.</span><span class="nx">bbb</span><span class="p">.</span><span class="nx">responses</span><span class="p">.</span><span class="nx">checksumError</span>
    <span class="kc">false</span>
  <span class="k">else</span>
    <span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Base method used to create a new meeting.
TODO: This exists only because of the mobile client, see <code>routes/mobile.create</code>.</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.createBase = </span><span class="nf">(req, res, callback) -&gt;</span>
  <span class="nv">urlObj = </span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="nv">m_id = </span><span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s2">&quot;meetingID&quot;</span><span class="p">]</span>
  <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="s2">&quot; request with: &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span><span class="p">),</span> <span class="nx">m_id</span>

  <span class="nx">unless</span> <span class="nx">m_id</span><span class="o">?</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;meetingID was not defined, forwarding call to BBB to get the error response&quot;</span>
    <span class="nx">LoadBalancer</span><span class="p">.</span><span class="nx">handle</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">LoadBalancer</span><span class="p">.</span><span class="nx">defaultServer</span><span class="p">()</span>
    <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If the meeting is not registered yet, create a new one.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">meeting = </span><span class="nx">Meeting</span><span class="p">.</span><span class="nx">getSync</span><span class="p">(</span><span class="nx">m_id</span><span class="p">)</span>
  <span class="nx">unless</span> <span class="nx">meeting</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;failed to load meeting&quot;</span><span class="p">,</span> <span class="nx">m_id</span>
    <span class="nv">server = </span><span class="nx">LoadBalancer</span><span class="p">.</span><span class="nx">selectServer</span><span class="p">()</span>
    <span class="nv">meeting = </span><span class="k">new</span> <span class="nx">Meeting</span><span class="p">(</span><span class="nx">m_id</span><span class="p">,</span> <span class="nx">server</span><span class="p">)</span>

  <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;successfully loaded meeting&quot;</span><span class="p">,</span> <span class="nx">m_id</span>
  <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;server selected &quot;</span> <span class="o">+</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">m_id</span>
  <span class="nx">callback</span> <span class="nx">meeting</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Routing a <code>create</code> request.</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.create = </span><span class="nf">(req, res, whenReady) -&gt;</span>
  <span class="nx">exports</span><span class="p">.</span><span class="nx">createBase</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nf">(meeting) -&gt;</span>
    <span class="nx">LoadBalancer</span><span class="p">.</span><span class="nx">handle</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">server</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nf">(useProxy, body) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If not proxying, we assume the meeting was created, otherwise check the response</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="o">not</span> <span class="nx">useProxy</span> <span class="o">or</span> <span class="nx">BigBlueButton</span><span class="p">.</span><span class="nx">isSuccessfulResponse</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
        <span class="nx">meeting</span><span class="p">.</span><span class="nx">saveSync</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Routing a <code>join</code> request.</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.join = </span><span class="nf">(req, res) -&gt;</span>
  <span class="nx">exports</span><span class="p">.</span><span class="nx">basicHandler</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nf">(meeting) -&gt;</span>
    <span class="nx">LoadBalancer</span><span class="p">.</span><span class="nx">handle</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">server</span><span class="p">,</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Routing a <code>end</code> request.</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.end = </span><span class="nf">(req, res) -&gt;</span>
  <span class="nx">exports</span><span class="p">.</span><span class="nx">basicHandler</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nf">(meeting) -&gt;</span>
    <span class="nx">LoadBalancer</span><span class="p">.</span><span class="nx">handle</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">server</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nf">(useProxy, body) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If not proxying, we assume the meeting was ended, otherwise check the response</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="o">not</span> <span class="nx">useProxy</span> <span class="o">or</span> <span class="nx">BigBlueButton</span><span class="p">.</span><span class="nx">isSuccessfulResponse</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
        <span class="nx">meeting</span><span class="p">.</span><span class="nx">destroySync</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Routing a <code>getMeetings</code> request.
TODO: this replicates some code from <code>BigBlueButton.repopulateMeetings()</code>.</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.getMeetings = </span><span class="nf">(req, res) -&gt;</span>
  <span class="nv">meetings = </span><span class="p">[]</span>
  <span class="nv">responses = </span><span class="p">[]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Send a getMeetings to all registered servers and concatenate the responses.
Since we're getting the list of meetings, we'll also update the meetings db.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">BigBlueButton</span><span class="p">.</span><span class="nx">sendGetMeetingsToAll</span> <span class="nf">(error, body, server) -&gt;</span>
    <span class="k">if</span> <span class="nx">error</span>
      <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;error calling getMeetings to &quot;</span> <span class="o">+</span> <span class="nx">server</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">error</span>
      <span class="nx">responses</span><span class="p">.</span><span class="nx">push</span> <span class="kc">null</span>
      <span class="nx">meetings</span><span class="p">.</span><span class="nx">push</span> <span class="kc">null</span>
    <span class="k">else</span>
      <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;got response to getMeetings from &quot;</span> <span class="o">+</span> <span class="nx">server</span><span class="p">.</span><span class="nx">name</span>
      <span class="nx">responses</span><span class="p">.</span><span class="nx">push</span> <span class="nx">body</span>
      <span class="nx">meetings</span><span class="p">.</span><span class="nx">push</span> <span class="nx">BigBlueButton</span><span class="p">.</span><span class="nx">meetingsFromGetMeetings</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">server</span><span class="p">)</span>

  <span class="p">,</span> <span class="nf">(total) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>First update the meetings db</p></div></div><div class="code"><div class="wrapper">    <span class="nx">Utils</span><span class="p">.</span><span class="nx">updateMeetings</span> <span class="nx">Utils</span><span class="p">.</span><span class="nx">flatten</span><span class="p">(</span><span class="nx">meetings</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>And send the response to the user</p></div></div><div class="code"><div class="wrapper">    <span class="nv">xml = </span><span class="nx">BigBlueButton</span><span class="p">.</span><span class="nx">concatenateGetMeetings</span><span class="p">(</span><span class="nx">responses</span><span class="p">)</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span> <span class="s2">&quot;xml&quot;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">xml</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Routing any request that simply needs to be passed to a BBB server.</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.anything = </span><span class="nf">(req, res) -&gt;</span>
  <span class="nx">exports</span><span class="p">.</span><span class="nx">basicHandler</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nf">(meeting) -&gt;</span>
    <span class="nx">LoadBalancer</span><span class="p">.</span><span class="nx">handle</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">server</span></div></div></div></div></body></html>