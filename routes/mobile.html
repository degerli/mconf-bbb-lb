<!DOCTYPE html><html lang="en"><head><title>routes/mobile</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="routes/mobile"><meta name="groc-project-path" content="routes/mobile.coffee"><meta name="groc-github-url" content="https://github.com/mconf/mconf-bbb-lb"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/mconf/mconf-bbb-lb/blob/master/routes/mobile.coffee">routes/mobile.coffee</a></div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="router-for-the-mobile-requests">Router for the mobile requests</h1>

<p>It will work always on proxy-mode.</p>

<p>This is an implementation of the <code>mobile.jsp</code> demo from BigBlueButton
<a href="https://github.com/bigbluebutton/bigbluebutton/blob/master/bbb-api-demo/src/main/webapp/mobile.jsp">https://github.com/bigbluebutton/bigbluebutton/blob/master/bbb-api-demo/src/main/webapp/mobile.jsp</a></p></div></div><div class="code"><div class="wrapper"><span class="nv">BigBlueButton = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../lib/bigbluebutton&quot;</span><span class="p">)</span>
<span class="nv">Logger = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../lib/logger&quot;</span><span class="p">)</span>
<span class="nv">Meeting = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/meeting&quot;</span><span class="p">)</span>
<span class="nv">Utils = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../lib/utils&quot;</span><span class="p">)</span>
<span class="nv">config = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../config&quot;</span><span class="p">)</span>
<span class="nv">request = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
<span class="nv">routes = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./index&quot;</span><span class="p">)</span>
<span class="nv">url = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Validates the checksum in the request <code>req</code> against the
mobile salt. If it doesn't match the expected checksum, we'll send
an XML response with an error code just like BBB does and
return false. Returns true if the checksum matches.</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.validateMobileChecksum = </span><span class="nf">(req, res) -&gt;</span>
  <span class="nv">urlObj = </span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="nv">checksum = </span><span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s2">&quot;checksum&quot;</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Matches the checksum in the url with the expected checksum</p></div></div><div class="code"><div class="wrapper">  <span class="nv">expectedChecksum = </span><span class="nx">BigBlueButton</span><span class="p">.</span><span class="nx">checksum</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">lb</span><span class="p">.</span><span class="nx">mobileSalt</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="nx">unless</span> <span class="nx">checksum</span> <span class="o">is</span> <span class="nx">expectedChecksum</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;mobile checksum check failed, sending a checksumError response&quot;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span> <span class="s2">&quot;xml&quot;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">config</span><span class="p">.</span><span class="nx">bbb</span><span class="p">.</span><span class="nx">responses</span><span class="p">.</span><span class="nx">checksumError</span>
    <span class="kc">false</span>
  <span class="k">else</span>
    <span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Validates the timestamp in the request <code>req</code>. If it is not within 1 minute
from the last timestamp sent, it sends a response with an error. Otherwise
it will return true.</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.validateTimestamp = </span><span class="nf">(req, res) -&gt;</span>
  <span class="nv">urlObj = </span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="nv">timestamp = </span><span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>
  <span class="nv">now = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If the last sent was more than 1min ago</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">now</span> <span class="o">-</span> <span class="nx">timestamp</span> <span class="o">&gt;</span> <span class="mi">60000</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;timestamp check failed, sending a timestampError response&quot;</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;received &quot;</span> <span class="o">+</span> <span class="nx">timestamp</span> <span class="o">+</span> <span class="s2">&quot;, base &quot;</span> <span class="o">+</span> <span class="nx">lastTimestamp</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span> <span class="s2">&quot;xml&quot;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">config</span><span class="p">.</span><span class="nx">bbb</span><span class="p">.</span><span class="nx">mobile</span><span class="p">.</span><span class="nx">responses</span><span class="p">.</span><span class="nx">timestampError</span>
    <span class="kc">false</span>
  <span class="k">else</span>
    <span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Sends a default error XML to the client</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.sendDefaultError = </span><span class="nf">(req, res) -&gt;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span> <span class="s2">&quot;xml&quot;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">config</span><span class="p">.</span><span class="nx">bbb</span><span class="p">.</span><span class="nx">mobile</span><span class="p">.</span><span class="nx">responses</span><span class="p">.</span><span class="nx">defaultError</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>All requests from the mobile app end up here</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.index = </span><span class="nf">(req, res) -&gt;</span>
  <span class="nv">urlObj = </span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="nv">action = </span><span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span>

  <span class="k">if</span> <span class="nx">action</span> <span class="o">is</span> <span class="s2">&quot;getTimestamp&quot;</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">getTimestamp</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">validateTimestamp</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We don't need the timestamp and action params anymore</p></div></div><div class="code"><div class="wrapper">    <span class="nx">Utils</span><span class="p">.</span><span class="nx">removeParamFromUrl</span> <span class="nx">urlObj</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">removeParamFromUrl</span> <span class="nx">urlObj</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span>
    <span class="nv">req.url = </span><span class="nx">url</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">urlObj</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Pretend this is a normal request for the api</p></div></div><div class="code"><div class="wrapper">    <span class="nv">req.url = </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">bbb</span><span class="p">.</span><span class="nx">mobile</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">bbb</span><span class="p">.</span><span class="nx">apiPath</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">action</span><span class="p">)</span>

    <span class="k">switch</span> <span class="nx">action</span>
      <span class="k">when</span> <span class="s2">&quot;getMeetings&quot;</span> <span class="k">then</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">getMeetings</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span>
      <span class="k">when</span> <span class="s2">&quot;create&quot;</span> <span class="k">then</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">create</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span>
      <span class="k">when</span> <span class="s2">&quot;join&quot;</span> <span class="k">then</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">join</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span>
      <span class="k">else</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">sendDefaultError</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Treats the action <code>getTimestamp</code>.</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.getTimestamp = </span><span class="nf">(req, res) -&gt;</span>
  <span class="nv">config.bbb.mobile.timestamp = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>
  <span class="nv">xml = </span><span class="nx">config</span><span class="p">.</span><span class="nx">bbb</span><span class="p">.</span><span class="nx">mobile</span><span class="p">.</span><span class="nx">responses</span><span class="p">.</span><span class="nx">getTimestamp</span>
  <span class="nv">xml = </span><span class="nx">xml</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/%%TIMESTAMP%%/</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">bbb</span><span class="p">.</span><span class="nx">mobile</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">)</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span> <span class="s2">&quot;xml&quot;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">xml</span>
  <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;sent the timestamp &quot;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">bbb</span><span class="p">.</span><span class="nx">mobile</span><span class="p">.</span><span class="nx">timestamp</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Treats the action <code>getMeetings</code>.
We can't use <code>routes.getMeetings()</code> because the mobile client expects
a <code>getMeetingInfo</code> to be called for each meeting in the list.</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.getMeetings = </span><span class="nf">(req, res) -&gt;</span>
  <span class="nv">allMeetings = </span><span class="p">[]</span>
  <span class="nv">meetings = </span><span class="p">[]</span>
  <span class="nv">responses = </span><span class="p">[]</span>

  <span class="nx">BigBlueButton</span><span class="p">.</span><span class="nx">sendGetMeetingsToAll</span> <span class="nf">(error, body, server) -&gt;</span>
    <span class="k">if</span> <span class="nx">error</span>
      <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;error calling getMeetings to &quot;</span> <span class="o">+</span> <span class="nx">server</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">error</span>
      <span class="nx">allMeetings</span><span class="p">.</span><span class="nx">push</span> <span class="kc">null</span>
    <span class="k">else</span>
      <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;got response to getMeetings from &quot;</span> <span class="o">+</span> <span class="nx">server</span><span class="p">.</span><span class="nx">name</span>
      <span class="nv">meetings = </span><span class="nx">BigBlueButton</span><span class="p">.</span><span class="nx">meetingsFromGetMeetings</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">server</span><span class="p">)</span>
      <span class="k">for</span> <span class="nx">id</span> <span class="k">of</span> <span class="nx">meetings</span>
        <span class="nx">allMeetings</span><span class="p">.</span><span class="nx">push</span> <span class="nx">meetings</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
  <span class="p">,</span> <span class="nf">(total) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>First update the meetings db</p></div></div><div class="code"><div class="wrapper">    <span class="nx">Utils</span><span class="p">.</span><span class="nx">updateMeetings</span> <span class="nx">allMeetings</span>

    <span class="k">if</span> <span class="nx">Meeting</span><span class="p">.</span><span class="nx">countSync</span><span class="p">()</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="nv">xml = </span><span class="nx">exports</span><span class="p">.</span><span class="nx">concatenateGetMeetingInfo</span><span class="p">(</span><span class="nx">responses</span><span class="p">)</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span> <span class="s2">&quot;xml&quot;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">xml</span>

    <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Call a <code>getMeetingInfo</code> for each meeting found in <code>getMeetings</code></p></div></div><div class="code"><div class="wrapper">      <span class="nx">exports</span><span class="p">.</span><span class="nx">sendGetMeetingInfoToAll</span> <span class="nx">allMeetings</span><span class="p">,</span> <span class="nf">(error, body, server) -&gt;</span>
        <span class="k">if</span> <span class="nx">error</span>
          <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;error calling getMeetingInfo to &quot;</span> <span class="o">+</span> <span class="nx">server</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">error</span>
          <span class="nx">responses</span><span class="p">.</span><span class="nx">push</span> <span class="kc">null</span>
        <span class="k">else</span>
          <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;got response to getMeetingInfo from &quot;</span> <span class="o">+</span> <span class="nx">server</span><span class="p">.</span><span class="nx">name</span>
          <span class="nx">responses</span><span class="p">.</span><span class="nx">push</span> <span class="nx">body</span>
      <span class="p">,</span> <span class="nf">(total) -&gt;</span>
        <span class="nv">xml = </span><span class="nx">exports</span><span class="p">.</span><span class="nx">concatenateGetMeetingInfo</span><span class="p">(</span><span class="nx">responses</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span> <span class="s2">&quot;xml&quot;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">xml</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Treats the action <code>create</code>.
We can't use <code>routes.create()</code> because the mobile client expects
different responses than those from the normal api.</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.create = </span><span class="nf">(req, res) -&gt;</span>
  <span class="nv">urlObj = </span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add some parameters that are mandatory and are added by <code>bbb_api.jsp</code> if
they don't exist</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="o">not</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s2">&quot;meetingID&quot;</span><span class="p">]</span><span class="o">?</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">+=</span> <span class="s2">&quot;&amp;name=&quot;</span> <span class="o">+</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s2">&quot;meetingID&quot;</span><span class="p">]</span>
  <span class="k">if</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s2">&quot;attendeePW&quot;</span><span class="p">]</span><span class="o">?</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">+=</span> <span class="s2">&quot;&amp;attendeePW=ap&quot;</span>
  <span class="k">if</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s2">&quot;moderatorPW&quot;</span><span class="p">]</span><span class="o">?</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">+=</span> <span class="s2">&quot;&amp;moderatorPW=mp&quot;</span>
  <span class="k">if</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s2">&quot;voiceBridge&quot;</span><span class="p">]</span><span class="o">?</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">+=</span> <span class="s2">&quot;&amp;voiceBridge=&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="mi">7000</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

  <span class="nx">routes</span><span class="p">.</span><span class="nx">createBase</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nf">(meeting) -&gt;</span>
    <span class="nv">newUrl = </span><span class="nx">BigBlueButton</span><span class="p">.</span><span class="nx">formatBBBUrl</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">server</span><span class="p">)</span>
    <span class="nv">opt =</span>
      <span class="nv">url: </span><span class="nx">newUrl</span>
      <span class="nv">timeout: </span><span class="nx">config</span><span class="p">.</span><span class="nx">lb</span><span class="p">.</span><span class="nx">requestTimeout</span>

    <span class="nx">request</span> <span class="nx">opt</span><span class="p">,</span> <span class="nf">(error, response, body) -&gt;</span>
      <span class="k">if</span> <span class="nx">error</span>
        <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;error proxying the request: &quot;</span> <span class="o">+</span> <span class="nx">error</span>
      <span class="k">else</span>
        <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;got the response from BBB, sending it to the user.&quot;</span>
        <span class="nx">Utils</span><span class="p">.</span><span class="nx">copyHeaders</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">res</span>
        <span class="k">if</span> <span class="nx">BigBlueButton</span><span class="p">.</span><span class="nx">isSuccessfulResponse</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">body</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/&lt;meetingID&gt;(.*)&lt;\/meetingID&gt;/</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="nv">msg = </span><span class="s2">&quot;Error &quot;</span> <span class="o">+</span> <span class="nx">body</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/&lt;messageKey&gt;(.*)&lt;\/messageKey&gt;/</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span>
          <span class="nx">msg</span> <span class="o">+=</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">body</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/&lt;message&gt;(.*)&lt;\/message&gt;/</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">msg</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Treats the action <code>join</code>.
TODO: this method wasn't tested yet</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.join = </span><span class="nf">(req, res) -&gt;</span>
  <span class="nv">urlObj = </span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>

  <span class="nx">routes</span><span class="p">.</span><span class="nx">basicHandler</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nf">(meeting) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s2">&quot;fullName&quot;</span><span class="p">]</span><span class="o">?</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">exports</span><span class="p">.</span><span class="nx">sendDefaultError</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span>

    <span class="nv">joinUrl = </span><span class="nx">BigBlueButton</span><span class="p">.</span><span class="nx">formatBBBUrl</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">server</span><span class="p">)</span>
    <span class="nv">enterUrl = </span><span class="nx">meeting</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">bbb</span><span class="p">.</span><span class="nx">apiPath</span> <span class="o">+</span> <span class="s2">&quot;/enter&quot;</span>

    <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;JOIN URL &quot;</span> <span class="o">+</span> <span class="nx">joinUrl</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;ENTER URL &quot;</span> <span class="o">+</span> <span class="nx">enterUrl</span>

    <span class="nv">opt =</span>
      <span class="nv">url: </span><span class="nx">joinUrl</span>
      <span class="nv">timeout: </span><span class="nx">config</span><span class="p">.</span><span class="nx">lb</span><span class="p">.</span><span class="nx">requestTimeout</span>
    <span class="nx">request</span> <span class="nx">opt</span><span class="p">,</span> <span class="nf">(joinError, joinRes, joinBody) -&gt;</span>
      <span class="k">if</span> <span class="nx">joinError</span>
        <span class="nx">exports</span><span class="p">.</span><span class="nx">sendDefaultError</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span>
      <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>console.log('JOIN BODY');
console.log(joinBody);</p></div></div><div class="code"><div class="wrapper">        <span class="nv">opt =</span>
          <span class="nv">url: </span><span class="nx">enterUrl</span>
          <span class="nv">timeout: </span><span class="nx">config</span><span class="p">.</span><span class="nx">lb</span><span class="p">.</span><span class="nx">requestTimeout</span>

        <span class="nx">request</span> <span class="nx">opt</span><span class="p">,</span> <span class="nf">(enterError, enterRes, enterBody) -&gt;</span>
          <span class="k">if</span> <span class="nx">enterError</span>
            <span class="nx">exports</span><span class="p">.</span><span class="nx">sendDefaultError</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span>
          <span class="k">else</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">enterBody</span>
            <span class="nx">Utils</span><span class="p">.</span><span class="nx">copyHeaders</span> <span class="nx">enterRes</span><span class="p">,</span> <span class="nx">res</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span> <span class="s2">&quot;xm&quot;</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">enterBody</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Calls <code>getMeetingInfo</code> for all <code>meetings</code>.
TODO: this is not in lib/bigbluebutton because it is only used for the
      mobile client and might be removed in the future</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.sendGetMeetingInfoToAll = </span><span class="nf">(meetings, afterEach, afterAll) -&gt;</span>
  <span class="nv">received = </span><span class="mi">0</span>
  <span class="nv">count = </span><span class="nx">meetings</span><span class="p">.</span><span class="nx">length</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Send a getMeetingInfo to all <code>meetings</code></p></div></div><div class="code"><div class="wrapper">  <span class="k">for</span> <span class="nx">id</span> <span class="k">of</span> <span class="nx">meetings</span>
    <span class="nv">request = </span><span class="nx">config</span><span class="p">.</span><span class="nx">bbb</span><span class="p">.</span><span class="nx">apiPath</span> <span class="o">+</span> <span class="s2">&quot;/getMeetingInfo?&quot;</span>
    <span class="nx">request</span> <span class="o">+=</span> <span class="s2">&quot;meetingID=&quot;</span> <span class="o">+</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">meetings</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">id</span><span class="p">)</span>
    <span class="nx">request</span> <span class="o">+=</span> <span class="s2">&quot;&amp;password=&quot;</span> <span class="o">+</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">meetings</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">password</span><span class="p">)</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">requestToServer</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">meetings</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">server</span><span class="p">,</span> <span class="nf">(error, response, body, server) -&gt;</span>
      <span class="nx">received</span><span class="o">++</span>
      <span class="nx">afterEach</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">server</span>
      <span class="k">if</span> <span class="nx">received</span> <span class="o">is</span> <span class="nx">count</span>
        <span class="nx">afterAll</span> <span class="nx">received</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Receives an array with responses from <code>getMeetingInfo</code> calls
and generates a response with all the meetings available.
TODO: this is not in lib/bigbluebutton because it is only used for the
      mobile client and might be removed in the future</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.concatenateGetMeetingInfo = </span><span class="nf">(responses) -&gt;</span>
  <span class="nv">responseMatcher = </span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;&lt;response&gt;(.*)&lt;/response&gt;&quot;</span><span class="p">)</span>
  <span class="nv">xml = </span><span class="s2">&quot;&lt;meetings&gt;&quot;</span>
  <span class="k">for</span> <span class="nx">id</span> <span class="k">of</span> <span class="nx">responses</span>
    <span class="nv">match = </span><span class="nx">responses</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span><span class="nx">responseMatcher</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">match</span><span class="o">?</span> <span class="o">and</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;meeting&gt;&quot;</span> <span class="o">+</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&lt;/meeting&gt;&quot;</span>
  <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/meetings&gt;&quot;</span>
  <span class="nx">xml</span></div></div></div></div></body></html>